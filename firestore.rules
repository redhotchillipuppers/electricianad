rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for validation
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    function isValidEmail(email) {
      return email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$');
    }

    function isValidPhone(phone) {
      return phone.matches('^[0-9\\s\\-\\+\\(\\)]+$');
    }

    // Quote requests collection
    match /quotes/{quoteId} {
      // Anyone can create a quote (public submission)
      // Updated to match actual data structure from submitQuote.ts
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'contactMethod', 'description', 'houseFlatNumber', 'streetName', 'postcode', 'createdAt'])
                    && isValidEmail(request.resource.data.email)
                    && request.resource.data.name is string && request.resource.data.name.size() > 0
                    && request.resource.data.contactMethod is string && request.resource.data.contactMethod.size() > 0
                    && request.resource.data.description is string
                    && request.resource.data.houseFlatNumber is string
                    && request.resource.data.streetName is string
                    && request.resource.data.postcode is string
                    && request.resource.data.createdAt is string
                    && (!request.resource.data.keys().hasAny(['phone']) || request.resource.data.phone is string)
                    && (!request.resource.data.keys().hasAny(['fileUrl']) || request.resource.data.fileUrl is string);

      // Only admins can read, update, and delete quotes
      allow read, update, delete: if isAdmin();
    }

    // Service providers collection
    match /serviceProviders/{providerId} {
      // Anyone can create a provider application (public submission)
      // Updated to match actual data structure from submitServiceProvider.ts
      allow create: if request.resource.data.keys().hasAll(['firstName', 'lastName', 'email', 'primaryContactNumber', 'serviceAreas', 'status', 'createdAt'])
                    && isValidEmail(request.resource.data.email)
                    && isValidPhone(request.resource.data.primaryContactNumber)
                    && request.resource.data.firstName is string && request.resource.data.firstName.size() > 0
                    && request.resource.data.lastName is string && request.resource.data.lastName.size() > 0
                    && request.resource.data.primaryContactNumber is string && request.resource.data.primaryContactNumber.size() > 0
                    && request.resource.data.serviceAreas is list && request.resource.data.serviceAreas.size() > 0
                    && request.resource.data.status == 'pending'
                    && request.resource.data.createdAt is string
                    && (!request.resource.data.keys().hasAny(['companyName']) || request.resource.data.companyName is string);

      // Allow anyone to read (needed for provider account creation to check if email is approved)
      // This is safe because provider applications are reviewed by admins before approval
      allow read: if true;

      // Only admins can update and delete provider applications
      allow update, delete: if isAdmin();
    }

    // Users collection (admin and provider accounts)
    match /users/{userId} {
      // Users can only read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Allow user creation for:
      // 1. Admins creating admin/superadmin accounts
      // 2. Authenticated users creating their own provider account
      allow create: if (
                      // Admins can create admin/superadmin users
                      isAdmin()
                      && request.resource.data.keys().hasAll(['email', 'role', 'createdAt'])
                      && isValidEmail(request.resource.data.email)
                      && request.resource.data.role in ['admin', 'superadmin']
                      && request.resource.data.createdAt is timestamp
                    ) || (
                      // Authenticated users can create their own provider account
                      isAuthenticated()
                      && request.auth.uid == userId
                      && request.resource.data.uid == request.auth.uid
                      && request.resource.data.role == 'provider'
                      && isValidEmail(request.resource.data.email)
                      && request.resource.data.email == request.auth.token.email
                      && request.resource.data.status in ['active', 'inactive']
                      && request.resource.data.providerId is string
                      && request.resource.data.firstName is string
                      && request.resource.data.lastName is string
                      && request.resource.data.createdAt is string
                    );

      // Users cannot update or delete their own document
      // Only superadmins can update/delete user documents
      allow update, delete: if isAdmin() &&
                             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // Deny access to all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
