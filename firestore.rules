rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for validation
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    function isProvider() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'provider';
    }

    function isAssignedProvider(quoteData) {
      return isProvider() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.providerId == quoteData.assignedProviderId;
    }

    function isValidEmail(email) {
      return email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$');
    }

    function isValidPhone(phone) {
      return phone.matches('^[0-9\\s\\-\\+\\(\\)]+$');
    }

    function getProviderIdForUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.providerId;
    }

    // Quote requests collection
    match /quotes/{quoteId} {
      // Anyone can create a quote (public submission)
      // Updated to match actual data structure from submitQuote.ts
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'contactMethod', 'description', 'houseFlatNumber', 'streetName', 'postcode', 'serviceArea', 'createdAt', 'assignedProviderId'])
                    && isValidEmail(request.resource.data.email)
                    && request.resource.data.name is string && request.resource.data.name.size() > 0
                    && request.resource.data.contactMethod is string && request.resource.data.contactMethod.size() > 0
                    && request.resource.data.description is string
                    && request.resource.data.houseFlatNumber is string
                    && request.resource.data.streetName is string
                    && request.resource.data.postcode is string
                    && request.resource.data.serviceArea is string && request.resource.data.serviceArea.size() > 0
                    && request.resource.data.createdAt is string
                    && request.resource.data.assignedProviderId == null
                    && (!request.resource.data.keys().hasAny(['phone']) || request.resource.data.phone is string)
                    && (!request.resource.data.keys().hasAny(['fileUrl']) || request.resource.data.fileUrl is string);

      // Admins can read/update/delete all quotes
      // Providers can read:
      //   1. Quotes assigned to them (full access)
      //   2. Unassigned quotes (to see eligible jobs)
      // Note: Unassigned means assignedProviderId doesn't exist or is null
      allow read: if isAdmin()
                  || isAssignedProvider(resource.data)
                  || (isProvider() && (!('assignedProviderId' in resource.data) || resource.data.assignedProviderId == null));

      // Allow updates from:
      // 1. Admins (full access)
      // 2. Assigned providers (limited to status and notes fields only)
      allow update: if isAdmin() || (
                      isAssignedProvider(resource.data)
                      && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'completionStatus', 'notes', 'completedAt', 'completedBy', 'providerNotes'])
                    );

      // Only admins can delete quotes
      allow delete: if isAdmin();
    }

    // Service providers collection
    match /serviceProviders/{providerId} {
      // Anyone can create a provider application (public submission)
      // Updated to match actual data structure from submitServiceProvider.ts
      allow create: if request.resource.data.keys().hasAll(['firstName', 'lastName', 'email', 'primaryContactNumber', 'serviceAreas', 'status', 'createdAt'])
                    && isValidEmail(request.resource.data.email)
                    && isValidPhone(request.resource.data.primaryContactNumber)
                    && request.resource.data.firstName is string && request.resource.data.firstName.size() > 0
                    && request.resource.data.lastName is string && request.resource.data.lastName.size() > 0
                    && request.resource.data.primaryContactNumber is string && request.resource.data.primaryContactNumber.size() > 0
                    && request.resource.data.serviceAreas is list && request.resource.data.serviceAreas.size() > 0
                    && request.resource.data.status == 'pending'
                    && request.resource.data.createdAt is string
                    && (!request.resource.data.keys().hasAny(['companyName']) || request.resource.data.companyName is string);

      // Multi-tier read access:
      // - Admins can see everything
      // - Providers can see their own record
      // - Public can only see approved providers (business directory model)
      allow read: if isAdmin() ||
                  (isProvider() && providerId == getProviderIdForUser()) ||
                  resource.data.status == 'approved';

      // Allow updates from:
      // 1. Admins (full access)
      // 2. Authenticated providers updating their own document to mark account as created
      // 3. Authenticated providers updating their own service areas
      allow update: if isAdmin() || (
                      isAuthenticated()
                      && resource.data.email == request.auth.token.email
                      && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['accountCreated', 'userId', 'accountCreatedAt'])
                      && request.resource.data.accountCreated == true
                      && request.resource.data.userId == request.auth.uid
                    ) || (
                      isProvider()
                      && providerId == getProviderIdForUser()
                      && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['serviceAreas'])
                      && request.resource.data.serviceAreas is list
                      && request.resource.data.serviceAreas.size() > 0
                    );

      // Only admins can delete provider applications
      allow delete: if isAdmin();
    }

    // Users collection (admin and provider accounts)
    match /users/{userId} {
      // Users can only read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Allow user creation for:
      // 1. Admins creating admin/superadmin accounts
      // 2. Authenticated users creating their own provider account
      allow create: if (
                      // Admins can create admin/superadmin users
                      isAdmin()
                      && request.resource.data.keys().hasAll(['email', 'role', 'createdAt'])
                      && isValidEmail(request.resource.data.email)
                      && request.resource.data.role in ['admin', 'superadmin']
                      && request.resource.data.createdAt is timestamp
                    ) || (
                      // Authenticated users can create their own provider account
                      isAuthenticated()
                      && request.auth.uid == userId
                      && request.resource.data.uid == request.auth.uid
                      && request.resource.data.role == 'provider'
                      && isValidEmail(request.resource.data.email)
                      && request.resource.data.email == request.auth.token.email
                      && request.resource.data.status in ['active', 'inactive']
                      && request.resource.data.providerId is string
                      && request.resource.data.firstName is string
                      && request.resource.data.lastName is string
                      && request.resource.data.createdAt is string
                      && (!request.resource.data.keys().hasAny(['companyName']) || request.resource.data.companyName is string)
                    );

      // Users cannot update or delete their own document
      // Only superadmins can update/delete user documents
      allow update, delete: if isAdmin() &&
                             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    // Job requests collection (provider job requests)
    match /jobRequests/{requestId} {
      // Providers can create requests for themselves
      // Must include all required fields and set status to 'pending'
      allow create: if isProvider()
                    && request.resource.data.keys().hasAll(['quoteId', 'quoteName', 'quotePostcode', 'quoteCreatedAt', 'providerId', 'providerName', 'requestedAt', 'status'])
                    && request.resource.data.providerId == getProviderIdForUser()
                    && request.resource.data.status == 'pending'
                    && request.resource.data.requestedAt is string
                    && request.resource.data.quoteId is string
                    && request.resource.data.quoteName is string
                    && request.resource.data.quotePostcode is string
                    && request.resource.data.quoteCreatedAt is string
                    && request.resource.data.providerName is string
                    && (!request.resource.data.keys().hasAny(['providerCompanyName']) || request.resource.data.providerCompanyName is string);

      // Read access:
      // - Admins can see all requests
      // - Providers can see their own requests
      // - Providers can see requests for quotes they might work on (for transparency)
      allow read: if isAdmin() ||
                  (isProvider() && resource.data.providerId == getProviderIdForUser());

      // Update access:
      // - Admins can update any request (for approval/rejection)
      // - Providers cannot update their own requests once submitted
      allow update: if isAdmin();

      // Delete access:
      // - Only admins can delete requests (for cleanup)
      allow delete: if isAdmin();
    }

    // Auto-approval settings
    match /settings/autoApproval {
      // Only admins can read settings
      allow read: if isAdmin();

      // Only admins can write settings
      // Ensure key fields are present and valid
      allow write: if isAdmin()
                   && request.resource.data.keys().hasAll(['enabled', 'ageThresholdHours', 'maxOpenJobsLimit', 'considerServiceArea', 'useWorkloadBalancing', 'useRatingWeight'])
                   && request.resource.data.enabled is bool
                   && request.resource.data.ageThresholdHours is number
                   && request.resource.data.ageThresholdHours >= 1
                   && request.resource.data.ageThresholdHours <= 720
                   && request.resource.data.maxOpenJobsLimit is number
                   && request.resource.data.maxOpenJobsLimit >= 1
                   && request.resource.data.maxOpenJobsLimit <= 100
                   && request.resource.data.considerServiceArea is bool
                   && request.resource.data.useWorkloadBalancing is bool
                   && request.resource.data.useRatingWeight is bool;
    }

    // Deny access to all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
